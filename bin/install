#!/usr/bin/env bash
set -eu
[ "${BASH_VERSINFO[0]}" -ge 3 ] && set -o pipefail

PLUGIN_DIR="$(dirname "${BASH_SOURCE[0]}")/.."

# shellcheck source=/dev/null
source "$PLUGIN_DIR/lib/helpers.sh"

install_golang() {
  local version="$1"
  local download_path="$2"
  local install_path="$3"
  created_tmp="0"

  if [ -z "$download_path" ]; then
    download_path=$(mktemp -dt asdf-golang.XXXX)
    created_tmp="1"
    ASDF_INSTALL_VERSION="$version" ASDF_DOWNLOAD_PATH="$download_path" "$PLUGIN_DIR/bin/download"
  fi

  tar -C "$install_path" -xzf "${download_path}/archive.tar.gz"

  if [ "1" = "$created_tmp" ]; then
    rm -r "$download_path"
  fi
}

install_default_go_pkgs() {
  local go_path="$1/go/bin"
  local default_go_pkgs="${ASDF_GOLANG_DEFAULT_PACKAGES_FILE:-${HOME}/.default-golang-pkgs}"
  IFS=. read -r go_major_version go_minor_version <<<"${2}"

  if [ ! -f "$default_go_pkgs" ]; then return; fi

  while read -r line; do
    # Skip empty lines and comments
    [[ -z "$line" || "$line" =~ ^[[:space:]]*// ]] && continue
    
    # Remove inline comments and trim whitespace
    name=$(echo "$line" | sed 's|//.*||' | xargs)
    
    # Skip if empty after processing
    [ -z "$name" ] && continue

    echo -ne "\nInstalling \033[33m${name}\033[39m go pkg... " >&2

    # if using go > 1.16 then use go install as the preferred download path
    if [ "$go_major_version" -ge 2 ] || [ "${go_minor_version//[!0-9]*/}" -ge 16 ]; then
      go_cmd=(install)
      if [[ $name != *"@"* ]]; then
        pkg_to_install="${name}@latest"
      else
        pkg_to_install="${name}"
      fi
    else
      go_cmd=(get -u)
      pkg_to_install="${name}"
    fi

    # Execute the go command with common environment
    if GOROOT="$ASDF_INSTALL_PATH/go" \
      GOPATH="$ASDF_INSTALL_PATH/packages" \
      GOBIN="$ASDF_INSTALL_PATH/bin" \
      PATH="$go_path:$PATH" \
      go "${go_cmd[@]}" "$pkg_to_install" >/dev/null 2>&1; then
      msg "SUCCESS"
    else
      err "FAIL"
    fi
  done <"$default_go_pkgs"
}

install_golang "$ASDF_INSTALL_VERSION" "${ASDF_DOWNLOAD_PATH:-}" "$ASDF_INSTALL_PATH"
install_default_go_pkgs "$ASDF_INSTALL_PATH" "$ASDF_INSTALL_VERSION"